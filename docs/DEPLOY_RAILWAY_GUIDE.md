# üöÄ Production Deployment Guide - Railway (Simplest)

**Estimated time**: 30 minutes  
**Difficulty**: Beginner-friendly  
**Cost**: $5/month (basic tier)

---

## 1Ô∏è‚É£ Create Railway Account

1. Go to https://railway.app
2. Sign up with GitHub
3. New Project ‚Üí "Deploy from GitHub"

---

## 2Ô∏è‚É£ Connect GitHub Repository

1. Select your repo: `dleci9150-ops/chega`
2. Approve GitHub permissions
3. Railway auto-detects `package.json` and `Dockerfile`

---

## 3Ô∏è‚É£ Create Services

Railway will auto-create:

### Backend Service
```
Name: chega-backend
Path: /backend
Dockerfile: Dockerfile.backend
```

### Frontend Service (Optional)
```
Name: chega-frontend
Path: /frontend
Dockerfile: Dockerfile.frontend
```

### Postgres Database
```
Railway Dashboard ‚Üí + New ‚Üí Database ‚Üí PostgreSQL
```

### Redis (Optional)
```
Railway Dashboard ‚Üí + New ‚Üí Database ‚Üí Redis
```

---

## 4Ô∏è‚É£ Generate .env Variables

Railway auto-generates connection strings. Copy these:

```bash
# From Railway Dashboard ‚Üí Variables

# Database (auto-generated)
DATABASE_URL=postgresql://...

# Redis (auto-generated)
REDIS_URL=redis://...
```

---

## 5Ô∏è‚É£ Configure Environment Variables

Railway Dashboard ‚Üí `chega-backend` ‚Üí Variables

Copy-paste this template and fill YOUR values:

```bash
# ===== SERVER =====
NODE_ENV=production
PORT=3001
APP_URL=https://chega-backend-prod.railway.app
TRUST_PROXY=true

# ===== DATABASE =====
# Auto-generated by Railway (copy from DB service)
DATABASE_URL=postgresql://postgres:password@pg.railway.internal:5432/railway

# ===== JWT =====
JWT_SECRET=your-super-secret-key-32-chars-minimum-xxxxxxxxxx
JWT_REFRESH_SECRET=your-refresh-secret-key-xxxxxxxxxx

# ===== STRIPE =====
STRIPE_SECRET_KEY=sk_live_YOUR_REAL_KEY_HERE
STRIPE_WEBHOOK_SECRET=whsec_test_xxxxx

# ===== EMAIL =====
EMAIL_USER=seu-email@gmail.com
EMAIL_PASS=your-app-password-from-google
EMAIL_FROM=noreply@seu-dominio.com

# ===== CORS =====
CORS_ORIGIN=https://chega-frontend-prod.railway.app,https://seu-dominio.com

# ===== RATE LIMITING =====
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=200
AUTH_LIMIT_MAX_REQUESTS=10
API_LIMIT_WINDOW_MS=60000
API_LIMIT_MAX_REQUESTS=60

# ===== DATABASE POOL =====
DB_POOL_MIN=2
DB_POOL_MAX=30
DB_IDLE_TIMEOUT_MS=30000
DB_CONNECTION_TIMEOUT_MS=5000

# ===== MONITORING =====
SENTRY_DSN=https://xxxxx@xxxxx.ingest.sentry.io/xxxxx
SENTRY_ENVIRONMENT=production

# ===== REDIS =====
# Auto-generated by Railway (copy from Redis service)
REDIS_URL=redis://default:password@redis.railway.internal:6379
```

---

## 6Ô∏è‚É£ Add Deployment Triggers

Railway Dashboard ‚Üí `chega-backend`:

1. **Build Command**: (Leave empty - detects automatically)
2. **Start Command**: 
   ```bash
   npm run migrate && npm start
   ```
3. **Port**: 3001

---

## 7Ô∏è‚É£ Run Database Migrations

Option A: Railway CLI
```bash
npm install -g @railway/cli
railway login
railway run npm run migrate
```

Option B: SSH into container
```bash
railway shell
npm run migrate
npm run seed
```

---

## 8Ô∏è‚É£ Deploy & Monitor

```bash
# Trigger deployment
git push origin main

# Railway auto-deploys on push

# Watch logs
railway logs -f

# Check health
curl https://chega-backend-prod.railway.app/health/full
```

---

## 9Ô∏è‚É£ Setup Frontend (Optional)

For frontend on Vercel (faster):

1. https://vercel.com/new
2. Import `dleci9150-ops/chega`
3. Root Directory: `./frontend`
4. Environment:
   ```
   NEXT_PUBLIC_API_URL=https://chega-backend-prod.railway.app
   NEXT_PUBLIC_SENTRY_DSN=https://...
   ```

---

## üîü Post-Deployment Checklist

```bash
# Health Check
curl https://chega-backend-prod.railway.app/health/full

# API Docs
https://chega-backend-prod.railway.app/api-docs

# Frontend
https://chega-frontend.vercel.app

# Sentry Dashboard
https://sentry.io/[seu-projeto]

# Check Logs
railway logs

# Test Email
POST /api/send-test-email

# Test Payment (Test Card)
4242 4242 4242 4242 (Stripe test)
```

---

## Troubleshooting

### App crashes after deploy?
```bash
railway logs -f
# Look for error messages
```

### Database connection failed?
```bash
# Check DATABASE_URL format
# Should be: postgresql://user:pass@host:port/db

# Test locally
psql $DATABASE_URL -c "SELECT 1"
```

### Migrations not running?
```bash
# SSH into container
railway shell
npm run migrate
npm run seed
```

### No emails being sent?
```bash
# Check EMAIL_PASS is App Password (not account password)
# https://accounts.google.com/b/0/AppPasswords

# Test queue worker
railway run npm run queue:worker
```

---

## üí∞ Cost Estimation

| Service | Railway Plan | Cost |
|---------|-------------|------|
| Backend | Standard | $0.50/GB RAM |
| Frontend | Vercel | Free |
| PostgreSQL | Standard | $5/month |
| Redis | Standard | $2/month |
| **Total** | - | **~$10-15/month** |

---

## Next Steps

1. ‚úÖ Deploy backend
2. ‚úÖ Deploy frontend
3. ‚úÖ Configure Sentry alerts
4. ‚úÖ Setup email notifications
5. ‚úÖ Setup on-call monitoring
6. ‚úÖ Run load tests

**You're live! üéâ**
