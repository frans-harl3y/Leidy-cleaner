// Jest setup after environment is ready.
// Place global mocks or test utilities here.
jest.setTimeout(60000); // Increased timeout to 60 seconds

const { Pool } = require('pg');
const path = require('path');

const pool = new Pool({
	host: process.env.DB_HOST || 'localhost',
	port: parseInt(process.env.DB_PORT || '5432'),
	database: process.env.DB_NAME || 'vammos_test',
	user: process.env.DB_USER || 'postgres',
	password: process.env.DB_PASSWORD || 'postgres',
});

beforeAll(async () => {
	try {
		console.log('ğŸ§¹ Setting up test database...');
		// Ensure a clean state once per worker (do not remove data between tests in same file)
		await pool.query('TRUNCATE TABLE bookings, reviews, services, users RESTART IDENTITY CASCADE');
		console.log('âœ… Database truncated successfully');

		// Reseed default data
		console.log('ğŸŒ± Seeding test data...');
		const { seedDatabase } = require('./src/db/seed');
		await seedDatabase();
		console.log('âœ… Test data seeded successfully');
	} catch (err) {
		console.error('âŒ Error in beforeAll:', err.message);
		console.error('Stack:', err.stack);
		throw err;
	}
});

afterAll(async () => {
	try {
		await pool.end();
		console.log('âœ… Database connection closed');
	} catch (err) {
		console.error('âŒ Error closing database:', err.message);
	}
});